using OpenDreamClient.Rendering;
using OpenDreamShared.Dream;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;

namespace OpenDreamClient.Input.ContextMenu;

[GenerateTypedNameReferences]
internal sealed partial class VerbMenuPopup : Popup {
    public delegate void VerbSelectedHandler();

    public VerbSelectedHandler? OnVerbSelected;

    private readonly IEntityManager _entityManager;
    private readonly ClientVerbSystem? _verbSystem;

    private readonly EntityUid _entity;

    public VerbMenuPopup(IEntityManager entityManager, ClientVerbSystem? verbSystem, sbyte seeInvisible, EntityUid entity, MetaDataComponent? entityMetaData, DMISpriteComponent? entitySprite) {
        RobustXamlLoader.Load(this);

        _entityManager = entityManager;
        _verbSystem = verbSystem;
        _entity = entity;

        if (entityMetaData != null && !string.IsNullOrEmpty(entityMetaData.EntityDescription)) {
            DescLabel.Margin = new Thickness(4, 0, 4, 0);
            DescLabel.Text = entityMetaData.EntityDescription;
        } else {
            Desc.Visible = false;
        }

        if (verbSystem != null && entitySprite?.Icon.Appearance?.Verbs is { } verbIds) {
            foreach (var verbId in verbIds) {
                if (!verbSystem.TryGetVerbInfo(verbId, out var verbInfo))
                    continue;
                if (verbInfo.IsHidden(false, seeInvisible))
                    continue;

                AddVerb(verbId, verbInfo);
            }
        }
    }

    private void AddVerb(int verbId, VerbSystem.VerbInfo verbInfo) {
        var netEntity = _entityManager.GetNetEntity(_entity);
        var button = new Button {
            Text = verbInfo.Name
        };

        button.OnPressed += _ => {
            _verbSystem?.ExecuteVerb(new(netEntity), verbId);
            Close();
            OnVerbSelected?.Invoke();
        };

        VerbMenu.AddChild(button);
    }
}
