using OpenDreamClient.Rendering;
using OpenDreamShared.Dream;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;

namespace OpenDreamClient.Interface.DebugWindows;

/// <summary>
/// A debug window that displays information about an icon
/// </summary>
[GenerateTypedNameReferences]
internal sealed partial class IconDebugWindow : OSWindow {
    private readonly DreamIcon _icon;

    public IconDebugWindow(DreamIcon icon) {
        RobustXamlLoader.Load(this);
        Owner = IoCManager.Resolve<IClyde>().MainWindow;
        Title = icon.Appearance?.Name ?? "Icon properties";

        _icon = icon;
        RefreshButton.OnPressed += OnRefreshPressed;
        Update();
    }

    private void Update() {
        // TODO: Include overlays and underlays? May be complicated to do
        Texture.Texture = _icon.LastRenderedTexture;

        var appearance = _icon.Appearance;
        if (appearance == null) {
            Tabs.Visible = false;
            Container.AddChild(new Label { Text = "Icon has no appearance" });

            return;
        }

        PropertiesTable.RemoveAllChildren();
        OverlaysGrid.RemoveAllChildren();
        UnderlaysGrid.RemoveAllChildren();
        VisContentsGrid.RemoveAllChildren();

        // Would be nice if we could use ViewVariables instead, but I couldn't find a nice way to do that
        // Would be especially nice if we could use VV to make these editable
        AddPropertyIfNotDefault("Name", appearance.Name, MutableAppearance.Default.Name);
        AddPropertyIfNotDefault("Desc", appearance.Desc, MutableAppearance.Default.Desc);
        AddPropertyIfNotDefault("Icon State", appearance.IconState, MutableAppearance.Default.IconState);
        AddPropertyIfNotDefault("Direction", appearance.Direction, MutableAppearance.Default.Direction);
        AddPropertyIfNotDefault("Inherits Direction", appearance.InheritsDirection, MutableAppearance.Default.InheritsDirection);
        AddPropertyIfNotDefault("Pixel Offset X/Y", appearance.PixelOffset, MutableAppearance.Default.PixelOffset);
        AddPropertyIfNotDefault("Pixel Offset W/Z", appearance.PixelOffset2, MutableAppearance.Default.PixelOffset2);
        AddPropertyIfNotDefault("Color", appearance.Color, MutableAppearance.Default.Color);
        AddPropertyIfNotDefault("Alpha", appearance.Alpha, MutableAppearance.Default.Alpha);
        AddPropertyIfNotDefault("Glide Size", appearance.GlideSize, MutableAppearance.Default.GlideSize);
        AddPropertyIfNotDefault("Layer", appearance.Layer, MutableAppearance.Default.Layer);
        AddPropertyIfNotDefault("Plane", appearance.Plane, MutableAppearance.Default.Plane);
        AddPropertyIfNotDefault("Blend Mode", appearance.BlendMode, MutableAppearance.Default.BlendMode);
        AddPropertyIfNotDefault("Appearance Flags", appearance.AppearanceFlags, MutableAppearance.Default.AppearanceFlags);
        AddPropertyIfNotDefault("Invisibility", appearance.Invisibility, MutableAppearance.Default.Invisibility);
        AddPropertyIfNotDefault("Opacity", appearance.Opacity, MutableAppearance.Default.Opacity);
        AddPropertyIfNotDefault("Override", appearance.Override, MutableAppearance.Default.Override);
        AddPropertyIfNotDefault("Render Source", appearance.RenderSource, MutableAppearance.Default.RenderSource);
        AddPropertyIfNotDefault("Render Target", appearance.RenderTarget, MutableAppearance.Default.RenderTarget);
        AddPropertyIfNotDefault("Mouse Opacity", appearance.MouseOpacity, MutableAppearance.Default.MouseOpacity);
        AddPropertyIfNotDefault("Map Text Offset", appearance.MaptextOffset, MutableAppearance.Default.MaptextOffset);
        AddPropertyIfNotDefault("Map Text Size", appearance.MaptextSize, MutableAppearance.Default.MaptextSize);
        AddPropertyIfNotDefault("Map Text", appearance.Maptext, MutableAppearance.Default.Maptext);

        foreach (var overlay in _icon.Overlays) {
            AddDreamIconButton(OverlaysGrid, overlay);
        }

        foreach (var underlay in _icon.Underlays) {
            AddDreamIconButton(UnderlaysGrid, underlay);
        }

        var entityManager = IoCManager.Resolve<IEntityManager>();
        foreach (var visContentNetEntity in appearance.VisContents) {
            var visContentEntity = entityManager.GetEntity(visContentNetEntity);

            if (entityManager.TryGetComponent(visContentEntity, out DMISpriteComponent? spriteComponent)) {
                AddDreamIconButton(VisContentsGrid, spriteComponent.Icon);
            } else {
                VisContentsGrid.AddChild(new Label { Text = $"Failed to get sprite component for {visContentEntity}" });
            }
        }
    }

    private void AddPropertyIfNotDefault(string propertyName, object? value, object? defaultValue) {
        if (value == null && defaultValue == null)
            return;
        if (value?.Equals(defaultValue) is true)
            return;

        PropertiesTable.AddChild(
            new Label {
                Text = propertyName,
                Margin = new(3, 0),
                HorizontalExpand = true
            }
        );

        PropertiesTable.AddChild(
            new Label {
                Text = value?.ToString() ?? "null",
                Margin = new(3, 0)
            }
        );
    }

    private void AddDreamIconButton(Control parent, DreamIcon icon) {
        var panel = new PanelContainer();

        panel.PanelOverride = new StyleBoxFlat(Color.White) {
            BorderThickness = new(1),
            BorderColor = Color.Black
        };

        var overlayButton = new TextureButton {
            TextureNormal = icon.LastRenderedTexture,
            SetSize = new(128, 128)
        };

        overlayButton.OnPressed += _ => {
            new IconDebugWindow(icon).Show();
        };

        panel.AddChild(overlayButton);
        parent.AddChild(panel);
    }

    private void OnRefreshPressed(BaseButton.ButtonEventArgs e) {
        Update();
    }
}
